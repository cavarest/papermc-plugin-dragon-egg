name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Get version from pom.xml
      id: get_version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"

    - name: Create and push tag
      if: github.event_name == 'workflow_dispatch'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Configure git identity for tagging
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        TAG="v${{ steps.get_version.outputs.version }}"
        echo "Creating tag $TAG"

        # Check if tag already exists
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists locally, deleting it first"
          git tag -d "$TAG"
        fi

        # Create annotated tag
        git tag -a "$TAG" -m "Release version ${{ steps.get_version.outputs.version }}"

        # Push tag to remote
        git push origin "$TAG"
        echo "Tag $TAG created and pushed successfully"

    - name: Build plugin using build.sh (production build)
      run: |
        echo "ğŸ—ï¸ Building production plugin using build.sh --production..."
        ./build.sh --production
        echo "Plugin built successfully"

    - name: Verify plugin.yml structure
      run: |
        echo "ğŸ” Verifying plugin.yml is correctly packaged..."
        JAR_FILE=$(find target -name "DragonEggLightning-*.jar" | head -1)
        echo "Found JAR: $JAR_FILE"
        jar tf "$JAR_FILE" | grep plugin.yml
        echo "âœ… Plugin.yml structure verified (no duplicate files)"

    - name: Generate changelog using GitHub Action
      id: changelog
      uses: janheinrichmerker/action-github-changelog-generator@v2.3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        output: RELEASE_CHANGELOG.md
        headerLabel: "## ğŸ“ Changes in v${{ steps.get_version.outputs.version }}"
        compareLink: true
        issues: true
        pullRequests: true
        author: true
        verbose: false

    - name: Create GitHub Release with auto-generated changelog
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Dragon Egg Lightning Plugin v${{ steps.get_version.outputs.version }}
        body: |
          ğŸ‰ **Dragon Egg Lightning Plugin v{{ steps.version.outputs.version }} Released!**

          ${{ steps.changelog.outputs.changelog }}

          ---

          ## ğŸ“¥ Installation Instructions

          ### For Server Administrators:
          1. **Download** the plugin JAR file below
          2. **Place** it in your Paper server's `plugins/` directory
          3. **Restart** your Paper 1.21.8+ server
          4. **Configure** - No additional configuration needed!

          ### For Players:
          - Get a Dragon Egg: `/give @p minecraft:dragon_egg`
          - Move to offhand: Press `F` key
          - Use ability: `/ability 1`

          ## âš¡ Features
          - **3 Sequential Lightning Strikes** with 0.5s intervals
          - **Purple Visual Effects** and thunder sounds
          - **Smart Targeting** - finds closest entity in view
          - **60-Second Cooldown** prevents spam (with smart behavior)
          - **4.5 Hearts Total Damage** (1.5 per strike)
          - **HUD Display** with real-time cooldown status
          - **Cooldown Management**: Death clears, item-independent, session-persistent

          ## ğŸ“Š Build Information
          - **Plugin Version**: {{ steps.version.outputs.version }}
          - **JAR File**: $(basename "$(find target -name "DragonEggLightning-*.jar" | head -1)")
          - **File Size**: $(du -h "$(find target -name "DragonEggLightning-*.jar" | head -1)" | cut -f1)
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Git Commit**: `${{ github.sha }}`
          - **Paper Version**: 1.21.8
          - **Java Version**: 21+
          - **Build System**: Updated GitHub workflows with build.sh integration

          ---
          **Report issues**: [GitHub Issues](https://github.com/${{ github.repository }}/issues)
          **Full documentation**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        files: |
          target/DragonEggLightning-*.jar
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload plugin JAR as artifact (backup)
      uses: actions/upload-artifact@v4
      with:
        name: plugin-jar-${{ steps.version.outputs.version }}
        path: target/DragonEggLightning-*.jar
        retention-days: 90

    - name: Verify Release Creation
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ‰ Verifying release creation..."
        echo ""

        # Check if release was created
        if gh release view ${{ steps.version.outputs.tag }} --json id --jq '.id' 2>/dev/null; then
          echo "âœ… Release ${{ steps.version.outputs.tag }} created successfully!"
          echo ""
          echo "ğŸ“¦ Release Assets:"
          gh release view ${{ steps.version.outputs.tag }} --json assets --jq '.assets[] | "  - \(.name): \(.size) bytes"'
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo ""
          echo "ğŸ“¥ Direct Download Link:"
          JAR_FILE=$(find target -name "DragonEggLightning-*.jar" | head -1 | xargs basename)
          echo "  https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/$JAR_FILE"
        else
          echo "âŒ Failed to create release"
          exit 1
        fi
