name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  integration-test:
    runs-on: ubuntu-latest

    services:
      # Use PostgreSQL if needed for complex server setups
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Install Docker Compose
      run: |
        sudo rm /usr/local/bin/docker-compose
        curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-Linux-x86_64 > docker-compose
        chmod +x docker-compose
        sudo mv docker-compose /usr/local/bin

    - name: Build plugin
      run: mvn clean package -DskipTests

    - name: Verify plugin JAR exists
      run: |
        ls -la target/DragonEggLightning-*.jar
        echo "Plugin JAR size: $(du -h target/DragonEggLightning-*.jar | cut -f1)"

    - name: Prepare server directory
      run: |
        mkdir -p server-data/plugins
        cp target/DragonEggLightning-*.jar server-data/plugins/
        ls -la server-data/plugins/

    - name: Start Paper server with plugin
      run: |
        docker-compose up -d
        echo "Waiting for server to start..."

    - name: Wait for server startup
      run: |
        echo "Checking server logs..."
        timeout 300 bash -c '
          until docker logs papermc-dragonegg 2>&1 | grep -q "Done"; do
            echo "Waiting for server startup..."
            sleep 10
          done
        '
        echo "Server startup completed!"

    - name: Check plugin loading
      run: |
        echo "Checking for plugin loading messages..."
        docker logs papermc-dragonegg 2>&1 | grep -i dragon
        echo "Plugin should be loaded if no errors above"

    - name: Create integration test script
      run: |
        cat > integration-test.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "Starting integration tests..."

        # Test 1: Plugin loads
        echo "Test 1: Checking plugin loading..."
        if docker logs papermc-dragonegg 2>&1 | grep -q "DragonEggLightning enabled"; then
          echo "✅ Plugin loaded successfully"
        else
          echo "❌ Plugin failed to load"
          exit 1
        fi

        # Test 2: Server responds to commands
        echo "Test 2: Checking server responsiveness..."
        sleep 30  # Give server time to fully initialize

        # Test 3: Check server health
        echo "Test 3: Server health check..."
        if docker ps | grep -q papermc-dragonegg; then
          echo "✅ Server container is running"
        else
          echo "❌ Server container is not running"
          docker logs papermc-dragonegg
          exit 1
        fi

        # Test 4: Verify no critical errors
        echo "Test 4: Checking for critical errors..."
        ERROR_COUNT=$(docker logs papermc-dragonegg 2>&1 | grep -i "error\|exception" | grep -v "INFO" | wc -l)
        if [ "$ERROR_COUNT" -eq 0 ]; then
          echo "✅ No critical errors found"
        else
          echo "⚠️  Found $ERROR_COUNT potential errors (may be non-critical)"
          docker logs papermc-dragonegg 2>&1 | grep -i "error\|exception" | tail -5
        fi

        # Test 5: Check memory usage
        echo "Test 5: Memory usage check..."
        MEMORY_USAGE=$(docker stats papermc-dragonegg --no-stream --format "table {{.MemUsage}}" | tail -1 | awk '{print $1}' | sed 's/MiB//')
        echo "Memory usage: ${MEMORY_USAGE}MiB"

        if [ "$MEMORY_USAGE" -lt 2048 ]; then
          echo "✅ Memory usage is acceptable"
        else
          echo "⚠️  High memory usage: ${MEMORY_USAGE}MiB"
        fi

        # Test 6: Server performance
        echo "Test 6: Server performance check..."
        sleep 10

        # Keep server running for a bit to check stability
        echo "Server running for stability test..."
        sleep 60

        if docker ps | grep -q papermc-dragonegg; then
          echo "✅ Server remained stable during test period"
        else
          echo "❌ Server crashed during test"
          docker logs papermc-dragonegg --tail 50
          exit 1
        fi

        echo "Integration tests completed successfully!"
        EOF
        chmod +x integration-test.sh

    - name: Run integration tests
      run: |
        ./integration-test.sh

    - name: Collect server logs
      if: always()
      run: |
        echo "=== Server logs (last 100 lines) ==="
        docker logs papermc-dragonegg --tail 100
        echo "=== End of logs ==="

    - name: Collect Docker stats
      if: always()
      run: |
        echo "=== Docker stats ==="
        docker stats papermc-dragonegg --no-stream
        echo "=== End of stats ==="

    - name: Stop server
      if: always()
      run: |
        echo "Stopping server..."
        docker-compose down
        docker system prune -f

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          integration-test.sh
          server-data/
        retention-days: 7

  docker-build-test:
    runs-on: ubuntu-latest
    needs: integration-test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test Docker image builds
      run: |
        echo "Testing that Docker Compose configuration is valid..."
        docker-compose config > /dev/null
        echo "✅ Docker Compose configuration is valid"

    - name: Test plugin JAR in clean environment
      run: |
        echo "Testing plugin JAR in isolated environment..."
        docker run --rm -v $(pwd)/target:/plugin alpine:latest \
          sh -c '
            ls -la /plugin/DragonEggLightning-*.jar
            file /plugin/DragonEggLightning-*.jar
            if file /plugin/DragonEggLightning-*.jar | grep -q "Java"; then
              echo "✅ JAR file appears to be valid Java bytecode"
            else
              echo "❌ JAR file does not appear to be valid Java bytecode"
              exit 1
            fi
          '
